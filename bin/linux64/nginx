#!/bin/sh
# nginx wrapper that looks for libraries only relative to the executable's directory,
# making the distribution portable.

# get full path of $0 without spawning a new process (this wrapper process is bad enough).
bindir="${0%nginx}"
curdir="$PWD"
cd "$bindir"
bindir="$PWD"
cd "$curdir"

luadir="$bindir/../.."                        # platform-indep. Lua modules
resty_luadir="$bindir/../../openresty"
platform_dir="$bindir/openresty/lua"          # platform-specific Lua modules

export LUA_CPATH="$bindir/clib/?.so"
export LUA_PATH="$platform_dir/?.lua;$resty_luadir/?.lua;$luadir/?.lua;$luadir/?/init.lua"
export TERRA_PATH="$luadir/?.t;$luadir/?/init.t"
export LD_LIBRARY_PATH="$bindir/openresty:$LD_LIBRARY_PATH"
exec "$bindir/nginx-bin" -p "$luadir" -c "$luadir/nginx.conf" "$@"
